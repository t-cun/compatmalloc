name: Publish to crates.io

on:
  push:
    tags:
      - "v*"

env:
  CARGO_TERM_COLOR: always

concurrency:
  group: publish
  cancel-in-progress: false

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ hashFiles('crates/**') }}

      - name: Verify tag matches Cargo.toml version
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          CARGO_VERSION="$(cargo metadata --no-deps --format-version 1 \
            | jq -r '.packages[] | select(.name == "compatmalloc") | .version')"
          if [ "$TAG_VERSION" != "$CARGO_VERSION" ]; then
            echo "::error::Tag version ($TAG_VERSION) does not match Cargo.toml version ($CARGO_VERSION)"
            exit 1
          fi
          echo "Publishing version $CARGO_VERSION"

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run tests
        run: cargo test -p compatmalloc

      - name: Run tests (no default features)
        run: cargo test -p compatmalloc --no-default-features

      - name: Clippy
        run: cargo clippy -p compatmalloc --all-targets --all-features -- -D warnings

      - name: Dry-run publish
        run: cargo publish -p compatmalloc --dry-run

      - name: Publish to crates.io
        run: cargo publish -p compatmalloc
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
