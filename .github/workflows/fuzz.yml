name: Fuzz

on:
  schedule:
    # Nightly at 01:00 UTC
    - cron: "0 1 * * *"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  discover-targets:
    name: Discover fuzz targets
    runs-on: ubuntu-latest
    outputs:
      targets: ${{ steps.list.outputs.targets }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz
      - name: List fuzz targets
        id: list
        working-directory: fuzz
        run: |
          targets=$(cargo fuzz list 2>/dev/null | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "targets=${targets}" >> "$GITHUB_OUTPUT"

  fuzz:
    name: Fuzz ${{ matrix.target }}
    runs-on: ubuntu-latest
    needs: discover-targets
    if: needs.discover-targets.outputs.targets != '[]'
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJson(needs.discover-targets.outputs.targets) }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz

      - name: Run fuzzer (${{ matrix.target }})
        working-directory: fuzz
        run: |
          cargo fuzz run ${{ matrix.target }} -- \
            -max_total_time=1800 \
            -max_len=65536

      - name: Upload crash artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-crashes-${{ matrix.target }}
          path: fuzz/artifacts/${{ matrix.target }}/
          retention-days: 30

      - name: Upload corpus
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-corpus-${{ matrix.target }}
          path: fuzz/corpus/${{ matrix.target }}/
          retention-days: 14
